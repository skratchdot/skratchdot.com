{"pageProps":{"slug":"/projects/mongodb-schema","filename":"_pages/projects/mongodb-schema/index.md","html":"<h1 id=\"mongodb---schemajs\">MongoDB - schema.js</h1>\n<p><a href=\"https://www.skratchdot.com/projects/mongodb-schema/\">Project Page</a><br><a href=\"https://github.com/skratchdot/mongodb-schema/\">Source Code</a><br><a href=\"https://github.com/skratchdot/mongodb-schema/issues/\">Issues</a></p>\n<h2 id=\"description\">Description:</h2>\n<p>This is a schema analysis tool for MongoDB. It accomplishes this by\nextending the mongo shell, and providing a new function called schema()\nwith the following signature:</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-title class_\">DBCollection</span>.<span class=\"hljs-property\"><span class=\"hljs-keyword\">prototype</span></span>.<span class=\"hljs-property\">schema</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">optionsOrOutString</span>)\n</code></pre>\n<p>The schema() function accepts all the same parameters that the mapReduce() function\ndoes. It adds/modifies the following 4 parameters that can be used as well:</p>\n<pre><code class=\"hljs language-plaintext\">wildcards - array (default: [])\n    By using the $, you can combine report results.\n    For instance: '$' will group all top level keys and\n    'foo.$.bar' will combine 'foo.baz.bar' and 'foo.bar.bar'\n\narraysAreWildcards - boolean (default: true)\n    When true, 'foo.0.bar' and 'foo.1.bar' will be\n    combined into 'foo.$.bar'\n    When false, all array keys will be reported\n\nfields - object (default: {})\n    Similar to the usage in find(). You can pick the\n    fields to include or exclude. Currently, you cannot\n    pass in nested structures, you need to pass in dot notation keys.\n\nlimit - number (default: 50)\n    Behaves the same as the limit in mapReduce(), but defaults to 50.\n    You can pass in 0 or -1 to process all documents.\n</code></pre>\n<h2 id=\"usage\">Usage:</h2>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-comment\">// Return schema results inline</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>();\n\n<span class=\"hljs-comment\">// Create and store schema results in the 'users_schema' collection</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>(<span class=\"hljs-string\">'users_schema'</span>); <span class=\"hljs-comment\">// Option 1</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>({ <span class=\"hljs-attr\">out</span>: <span class=\"hljs-string\">'users_schema'</span> }); <span class=\"hljs-comment\">// Option 2</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>({ <span class=\"hljs-attr\">out</span>: { <span class=\"hljs-attr\">replace</span>: <span class=\"hljs-string\">'users_schema'</span> } }); <span class=\"hljs-comment\">// Option 3</span>\n\n<span class=\"hljs-comment\">// Only report on the key: 'name.first'</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>({ <span class=\"hljs-attr\">fields</span>: { <span class=\"hljs-string\">'name.first'</span>: <span class=\"hljs-number\">1</span> } });\n\n<span class=\"hljs-comment\">// Report on everything except 'name.first'</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>({ <span class=\"hljs-attr\">fields</span>: { <span class=\"hljs-string\">'name.first'</span>: -<span class=\"hljs-number\">1</span> } });\n\n<span class=\"hljs-comment\">// Combine the 'name.first' and 'name.last' keys into 'name.$'</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>({ <span class=\"hljs-attr\">wildcards</span>: [<span class=\"hljs-string\">'name.$'</span>] });\n\n<span class=\"hljs-comment\">// Don't treat arrays as a wildcard</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>({ <span class=\"hljs-attr\">arraysAreWildcards</span>: <span class=\"hljs-literal\">false</span> });\n\n<span class=\"hljs-comment\">// Process 50 documents</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>();\n\n<span class=\"hljs-comment\">// Process all documents</span>\ndb.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>({ <span class=\"hljs-attr\">limit</span>: -<span class=\"hljs-number\">1</span> });\n</code></pre>\n<h2 id=\"example-result-set\">Example Result Set:</h2>\n<pre><code class=\"hljs language-javascript\">&gt; <span class=\"hljs-comment\">// Start fresh with a new collection called 'users'</span>\n&gt; db.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">remove</span>();\n&gt;\n&gt; <span class=\"hljs-comment\">// Add a few records with different schemas</span>\n&gt; db.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">insert</span>({<span class=\"hljs-string\">'name'</span> : {<span class=\"hljs-string\">'first'</span> : <span class=\"hljs-string\">'John'</span>, <span class=\"hljs-string\">'last'</span> : <span class=\"hljs-string\">'Smith'</span>}, <span class=\"hljs-string\">'isRegistered'</span> : <span class=\"hljs-literal\">false</span>, <span class=\"hljs-string\">'tags'</span> : [<span class=\"hljs-string\">'male'</span>]});\n&gt; db.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">insert</span>({<span class=\"hljs-string\">'name'</span> : {<span class=\"hljs-string\">'first'</span> : <span class=\"hljs-string\">'Bob'</span>, <span class=\"hljs-string\">'last'</span> : <span class=\"hljs-string\">'Smith'</span>}, <span class=\"hljs-string\">'isRegistered'</span> : <span class=\"hljs-literal\">false</span>, <span class=\"hljs-string\">'tags'</span> : [<span class=\"hljs-string\">'male'</span>,<span class=\"hljs-string\">'new'</span>]});\n&gt; db.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">insert</span>({<span class=\"hljs-string\">'name'</span> : {<span class=\"hljs-string\">'first'</span> : <span class=\"hljs-string\">'Amy'</span>, <span class=\"hljs-string\">'last'</span> : <span class=\"hljs-string\">'Smart'</span>}, <span class=\"hljs-string\">'isRegistered'</span> : <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">'tags'</span> : [<span class=\"hljs-string\">'female'</span>]});\n&gt; db.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">insert</span>({<span class=\"hljs-string\">'name'</span> : <span class=\"hljs-string\">'Bob Smith'</span>, <span class=\"hljs-string\">'isRegistered'</span> : <span class=\"hljs-string\">'0'</span>, <span class=\"hljs-string\">'tags'</span> : [<span class=\"hljs-string\">'male'</span>]});\n&gt;\n&gt; <span class=\"hljs-comment\">// Print our results to the console</span>\n&gt; db.<span class=\"hljs-property\">users</span>.<span class=\"hljs-title function_\">schema</span>();\n<span class=\"hljs-title class_\">Processing</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-title function_\">document</span>(s)...\n{\n  <span class=\"hljs-string\">\"results\"</span> : [\n    {\n      <span class=\"hljs-string\">\"_id\"</span> : <span class=\"hljs-string\">\"_id\"</span>,\n      <span class=\"hljs-string\">\"value\"</span> : {\n        <span class=\"hljs-string\">\"wildcard\"</span> : <span class=\"hljs-literal\">false</span>,\n        <span class=\"hljs-string\">\"types\"</span> : [<span class=\"hljs-string\">\"objectid\"</span>],\n        <span class=\"hljs-string\">\"results\"</span> : [\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"all\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"objectid\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>}\n        ]\n      }\n    },\n    {\n      <span class=\"hljs-string\">\"_id\"</span> : <span class=\"hljs-string\">\"isRegistered\"</span>,\n      <span class=\"hljs-string\">\"value\"</span> : {\n        <span class=\"hljs-string\">\"wildcard\"</span> : <span class=\"hljs-literal\">false</span>,\n        <span class=\"hljs-string\">\"types\"</span> : [<span class=\"hljs-string\">\"boolean\"</span>,<span class=\"hljs-string\">\"number\"</span>,<span class=\"hljs-string\">\"string\"</span>],\n        <span class=\"hljs-string\">\"results\"</span> : [\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"all\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"boolean\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">2</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">50</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"number\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">25</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"string\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">25</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>}\n        ]\n      }\n    },\n    {\n      <span class=\"hljs-string\">\"_id\"</span> : <span class=\"hljs-string\">\"name\"</span>,\n      <span class=\"hljs-string\">\"value\"</span> : {\n        <span class=\"hljs-string\">\"wildcard\"</span> : <span class=\"hljs-literal\">false</span>,\n        <span class=\"hljs-string\">\"types\"</span> : [<span class=\"hljs-string\">\"bson\"</span>,<span class=\"hljs-string\">\"string\"</span>],\n        <span class=\"hljs-string\">\"results\"</span> : [\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"all\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"bson\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">3</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">75</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"string\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">25</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>}\n        ]\n      }\n    },\n    {\n      <span class=\"hljs-string\">\"_id\"</span> : <span class=\"hljs-string\">\"name.first\"</span>,\n      <span class=\"hljs-string\">\"value\"</span> : {\n        <span class=\"hljs-string\">\"wildcard\"</span> : <span class=\"hljs-literal\">false</span>,\n        <span class=\"hljs-string\">\"types\"</span> : [<span class=\"hljs-string\">\"string\"</span>],\n        <span class=\"hljs-string\">\"results\"</span> : [\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"all\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">3</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">75</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"string\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">3</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">75</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>}\n        ]\n      }\n    },\n    {\n      <span class=\"hljs-string\">\"_id\"</span> : <span class=\"hljs-string\">\"name.last\"</span>,\n      <span class=\"hljs-string\">\"value\"</span> : {\n        <span class=\"hljs-string\">\"wildcard\"</span> : <span class=\"hljs-literal\">false</span>,\n        <span class=\"hljs-string\">\"types\"</span> : [<span class=\"hljs-string\">\"string\"</span>],\n        <span class=\"hljs-string\">\"results\"</span> : [\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"all\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">3</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">75</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"string\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">3</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">75</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>}\n        ]\n      }\n    },\n    {\n      <span class=\"hljs-string\">\"_id\"</span> : <span class=\"hljs-string\">\"tags\"</span>,\n      <span class=\"hljs-string\">\"value\"</span> : {\n        <span class=\"hljs-string\">\"wildcard\"</span> : <span class=\"hljs-literal\">false</span>,\n        <span class=\"hljs-string\">\"types\"</span> : [<span class=\"hljs-string\">\"array\"</span>],\n        <span class=\"hljs-string\">\"results\"</span> : [\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"all\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"array\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1</span>}\n        ]\n      }\n    },\n    {\n      <span class=\"hljs-string\">\"_id\"</span> : <span class=\"hljs-string\">\"tags.$\"</span>,\n      <span class=\"hljs-string\">\"value\"</span> : {\n        <span class=\"hljs-string\">\"wildcard\"</span> : <span class=\"hljs-literal\">true</span>,\n        <span class=\"hljs-string\">\"types\"</span> : [<span class=\"hljs-string\">\"string\"</span>],\n        <span class=\"hljs-string\">\"results\"</span> : [\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"all\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1.25</span>},\n          {<span class=\"hljs-string\">\"type\"</span> : <span class=\"hljs-string\">\"string\"</span>,<span class=\"hljs-string\">\"docs\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"coverage\"</span> : <span class=\"hljs-number\">100</span>,<span class=\"hljs-string\">\"perDoc\"</span> : <span class=\"hljs-number\">1.25</span>}\n        ]\n      }\n    }\n  ],\n  <span class=\"hljs-string\">\"timeMillis\"</span> : <span class=\"hljs-number\">16</span>,\n  <span class=\"hljs-string\">\"counts\"</span> : {<span class=\"hljs-string\">\"input\"</span> : <span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">\"emit\"</span> : <span class=\"hljs-number\">26</span>,<span class=\"hljs-string\">\"reduce\"</span> : <span class=\"hljs-number\">7</span>,<span class=\"hljs-string\">\"output\"</span> : <span class=\"hljs-number\">7</span>},\n  <span class=\"hljs-string\">\"ok\"</span> : <span class=\"hljs-number\">1</span>,\n}\n</code></pre>\n<h2 id=\"caveats\">Caveats:</h2>\n<p>By design, schema() returns 'bson' rather than 'object'.\nIt will return 'numberlong' rather than 'number', etc.</p>\n<h2 id=\"installation\">Installation:</h2>\n<p>Download: <a href=\"https://github.com/skratchdot/mongodb-schema/raw/master/schema.js\">schema.js</a></p>\n<h3 id=\"option-1\">Option 1</h3>\n<p>Add this script to your .mongorc.js file.</p>\n<p>See: <a href=\"http://www.mongodb.org/display/DOCS/Overview+-+The+MongoDB+Interactive+Shell#Overview-TheMongoDBInteractiveShell-.mongorc.js\">http://www.mongodb.org/display/DOCS/Overview+-+The+MongoDB+Interactive+Shell#Overview-TheMongoDBInteractiveShell-.mongorc.js</a></p>\n<h3 id=\"option-2\">Option 2</h3>\n<p>Start the shell after executing this script</p>\n<pre><code class=\"hljs language-plaintext\">mongo --shell schema.js\n</code></pre>\n<h2 id=\"inspired-by\">Inspired by:</h2>\n<p>Variety: <a href=\"https://github.com/JamesCropcho/variety\">https://github.com/JamesCropcho/variety</a></p>\n","frontmatter":{"layout":"page","title":"MongoDB - schema.js"}},"__N_SSG":true}